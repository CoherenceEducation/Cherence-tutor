<!-- ===== Full Page Coherence Chat (LW logged-in only) ===== -->
<style>
  /* Full page iframe container */
  .ce-fullpage-chat {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    width: 100vw;
    height: 100vh;
    background: #fafafa;
  }

  /* Iframe takes full viewport */
  .ce-chat-iframe {
    width: 100%;
    height: 100%;
    border: 0;
    display: block;
  }

  /* Loading overlay */
  .ce-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fafafa;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    z-index: 10;
    transition: opacity 0.3s ease;
  }

  .ce-loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Enhanced loader */
  .ce-loader {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(247, 181, 56, 0.2);
    border-top: 4px solid #f7b538;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .ce-loading-text {
    color: #023047;
    font-size: 16px;
    font-weight: 600;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  /* Error message */
  .ce-error-message {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #023047 0%, #f7b538 100%);
    color: white;
    padding: 24px 32px;
    border-radius: 16px;
    font-size: 15px;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 10px 40px rgba(2, 48, 71, 0.3);
    z-index: 10000;
    max-width: 400px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .ce-error-message.show {
    display: block;
    animation: slideInError 0.3s ease;
  }

  @keyframes slideInError {
    from { opacity: 0; transform: translate(-50%, -40%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
  }

  /* Hide default page elements when chat is active */
  body.ce-chat-active {
    overflow: hidden;
  }
</style>

<!-- Root container appended to <body> -->
<script>
(function(){
  // ---- CONFIG ----
  const BACKEND = "https://cherence-tutor.vercel.app/"; // Your deployed Vercel URL

  // LW Liquid variables (render only for logged-in users)
  const LW_USER = {
    id: "{{user.id}}",
    username: "{{user.username}}",
    email: "{{user.email}}"
  };

  // Guard: if Liquid didn't render (not logged in), quit silently
  if (!LW_USER.id || String(LW_USER.id).includes("{{")) {
    console.warn("Coherence Chat: User not logged in");
    return;
  }

  // Create full-page container
  const container = document.createElement("div");
  container.className = "ce-fullpage-chat";
  container.innerHTML = `
    <div class="ce-loading-overlay" id="ceLoadingOverlay">
      <div class="ce-loader"></div>
      <div class="ce-loading-text">Connecting to AI Tutor...</div>
    </div>
    <iframe 
      class="ce-chat-iframe" 
      id="ceChatIframe"
      title="Coherence AI Tutor"
      allow="clipboard-read; clipboard-write"
    ></iframe>
  `;

  const errorMsg = document.createElement("div");
  errorMsg.className = "ce-error-message";
  errorMsg.id = "ceErrorMessage";

  // Append to body
  document.body.appendChild(container);
  document.body.appendChild(errorMsg);
  document.body.classList.add("ce-chat-active");

  const iframe = document.getElementById("ceChatIframe");
  const loadingOverlay = document.getElementById("ceLoadingOverlay");
  const errorMessage = document.getElementById("ceErrorMessage");

  // Token caching
  const cacheKey = `ce.jwt.${LW_USER.id}`;
  
  function getCachedToken(){
    try{
      const raw = localStorage.getItem(cacheKey);
      if(!raw) return null;
      const {token, ts} = JSON.parse(raw);
      if(Date.now() - ts > 20*60*60*1000) return null; // >20h old
      return token;
    }catch{ return null; }
  }
  
  function setCachedToken(token){
    try{ 
      localStorage.setItem(cacheKey, JSON.stringify({token, ts: Date.now()})); 
    }catch{}
  }

  function showError(message){
    errorMessage.textContent = message;
    errorMessage.classList.add("show");
    setTimeout(() => {
      errorMessage.classList.remove("show");
    }, 4000);
  }

  async function fetchToken(){
    try{
      const cached = getCachedToken();
      if (cached) {
        return cached;
      }

      const payload = {
        student_id: LW_USER.id,
        email: LW_USER.email,
        name: LW_USER.username || ""
      };

      const res = await fetch(`${BACKEND}/api/auth/token`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      
      if(!res.ok){
        const t = await res.text();
        throw new Error(`Token error ${res.status}: ${t}`);
      }
      
      const {token} = await res.json();
      setCachedToken(token);
      return token;
      
    } catch(err) {
      throw err;
    }
  }

  async function initializeChat(){
    try{
      const token = await fetchToken();
      iframe.src = `${BACKEND}/chat?token=${encodeURIComponent(token)}`;
      
      // Hide loading overlay when iframe loads
      iframe.onload = function() {
        setTimeout(() => {
          loadingOverlay.classList.add("hidden");
        }, 500);
      };
      
    }catch(err){
      console.error("AI Tutor initialization failed:", err);
      loadingOverlay.classList.add("hidden");
      showError("⚠️ Unable to connect. Please refresh the page.");
    }
  }

  // Initialize immediately
  initializeChat();

  // Listen for messages from iframe
  window.addEventListener("message", (e) => {
    // Handle any cross-origin messages if needed
    if (e.origin !== BACKEND.replace(/\/$/, '')) return;
    
    // You can add custom message handlers here
    console.log("Message from chat:", e.data);
  });

})();
</script>
<!-- ===== /Full Page Coherence Chat ===== -->
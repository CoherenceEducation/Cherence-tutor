<!-- ===== Full-Page Admin Dashboard (Inline Embed) ===== -->
<style>
  /* Remove LearnWorlds section + column wrappers */
  #section_1760631473595_361,
  #section_1760631473595_361 .learnworlds-section-content,
  #el_1760631473608_366 {
    padding: 0 !important;
    margin: 0 !important;
    max-width: 100% !important;
    width: 100% !important;
    background: transparent !important;
    border: 0 !important;
  }
  
  /* make the dashboard truly full-width/full-height */
  .ce-admin-root {
    width: 100vw;
    height: 100vh;
    background: #fff;
    overflow: hidden;
  }
  
  .ce-admin-iframe {
    width: 100%;
    height: 100%;
    border: 0;
    display: none;
  }
  
  .ce-admin-notice {
    display: none;
    padding: 1rem;
    background: #fff3cd;
    border: 1px solid #ffe69c;
    color: #92400e;
    border-radius: 8px;
    font-weight: 600;
  }
  </style>
  
  
  <div id="ce-admin-root" class="ce-admin-root">
    <div id="ce-admin-notice" class="ce-admin-notice"></div>
    <iframe id="ce-admin-iframe" class="ce-admin-iframe" title="Admin Dashboard"></iframe>
  </div>
  
  <script>
  (function(){
    // ---- CONFIG ----
    const BACKEND = "https://cherence-tutor.vercel.app"; // âœ… your deployed URL
    const AUTO_LOAD = true; // set to false if you only want to load on a button click
    const ADMIN_EMAILS = [
      'andrew@coherence.org',
      'mina@coherenceeducation.org', 
      'support@coherenceeducation.org',
      'evan.senour@gmail.com',
      'gavinli.automation@gmail.com',
      'gavin@coherenceeducation.org'
    ].map(e => e.toLowerCase());
  
    // LW Liquid user variables
    const LW_USER = {
      id: "{{user.id}}",
      username: "{{user.username}}",
      email: "{{user.email}}"
    };
  
    const root = document.getElementById('ce-admin-root');
    const iframe = document.getElementById('ce-admin-iframe');
    const notice = document.getElementById('ce-admin-notice');
  
    // Quick checks
    if (!LW_USER.id || String(LW_USER.id).includes("{{")) {
      showNotice("Please sign in to access the Admin Dashboard.");
      return;
    }
    if (!LW_USER.email || !ADMIN_EMAILS.includes(LW_USER.email.toLowerCase())) {
      showNotice("You do not have permission to view the Admin Dashboard.");
      return;
    }
  
    // Token caching (optional)
    const cacheKey = `ce.admin.jwt.${LW_USER.id}`;
    function getCachedToken(){
      try {
        const raw = localStorage.getItem(cacheKey);
        if(!raw) return null;
        const {token, ts} = JSON.parse(raw);
        if(Date.now() - ts > 20*60*60*1000) return null; // older than 20h
        return token;
      } catch { return null; }
    }
    function setCachedToken(token){
      try { localStorage.setItem(cacheKey, JSON.stringify({token, ts: Date.now()})); } catch {}
    }
  
    async function fetchAdminToken(){
      const cached = getCachedToken();
      if (cached) return cached;
  
      const payload = {
        student_id: LW_USER.id,
        email: LW_USER.email,
        name: LW_USER.username || ""
      };
  
      const res = await fetch(`${BACKEND}/api/auth/token`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
  
      if(!res.ok){
        const t = await res.text();
        throw new Error(`Token error ${res.status}: ${t}`);
      }
      const data = await res.json();
      if (!data.is_admin) throw new Error("Admin access required");
  
      setCachedToken(data.token);
      return data.token;
    }
  
    function showNotice(msg){
      notice.textContent = msg;
      notice.style.display = 'block';
    }
  
    async function mountInline(){
      try {
        const token = await fetchAdminToken();
        iframe.src = `${BACKEND}/admin?token=${encodeURIComponent(token)}`;
        iframe.style.display = 'block';
      } catch (err) {
        console.warn("Admin mount failed:", err);
        showNotice("Unable to load the Admin Dashboard. Please try again or contact support.");
      }
    }
  
    // Auto-load the dashboard for admins
    if (AUTO_LOAD) {
      mountInline();
    }
  })();
  </script>
  <!-- ===== /Full-Page Admin Dashboard (Inline Embed) ===== -->
  